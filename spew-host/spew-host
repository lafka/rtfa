#!/bin/bash

spewdir=$(dirname $(dirname $(realpath "$0")))

bridge=tm
name=spew
cidr=${1:-172.20.48.1/24}
domain=${2:-$name.tm}


# Fix issue with gefooked udp checksums over the bridge
iptables \
	-A POSTROUTING \
	-t mangle \
	-p udp \
	--dport bootpc \
	-j CHECKSUM \
	--checksum-fill

env=$(mktemp -u)
buildpath=$(realpath $(eval echo ~$SUDO_USER/.spew/builds))

cat > "$env" <<EOF
# Autogenerated by spew-host
ENV=$ENV
HOSTNET=$cidr
SPEWHOST=$domain
EOF


../spew-build/bin/spew-build run \
	"$name" \
	spew/alpha \
		--network-bridge "$bridge" \
		--bind "$env:/spew-config" \
		--bind "$spewdir:/app" \
		--bind "$buildpath:/home/spew/.spew/builds" \
		--boot

rm "$env"
